# =========================
# Apache / Nginx Web Logs
# =========================
filter {
  if [type] == "web" {
    # Parse standard Apache/Nginx combined log format
    grok {
      match => { "message" => "%{COMMONAPACHELOG}" }
      remove_field => ["message"]
    }

    # Extract HTTP response code as number
    mutate {
      convert => { "response" => "integer" }
    }

    # Extract bytes sent as number
    mutate {
      convert => { "bytes" => "integer" }
    }

    # Parse timestamp
    date {
      match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
      target => "@timestamp"
    }

    # Add a field for source type
    mutate {
      add_field => { "log_category" => "web" }
    }
  }

  # =========================
  # Linux Security Logs
  # =========================
  if [type] == "security" {
    grok {
      match => { 
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host} %{WORD:process}(?:\[%{NUMBER:pid}\])?: %{GREEDYDATA:msg}" 
      }
    }

    # Optional: detect failed SSH logins
    if "Failed password" in [msg] {
      mutate {
        add_tag => ["ssh_failed_login"]
      }
    }

    # Optional: detect sudo sessions
    if "sudo:" in [msg] {
      mutate {
        add_tag => ["sudo_session"]
      }
    }

    # Parse timestamp
    date {
      match => ["timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss"]
      target => "@timestamp"
    }

    # Add a field for source type
    mutate {
      add_field => { "log_category" => "security" }
    }
  }
}
